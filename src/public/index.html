<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Netherlink</title>
    <link rel="icon" type="image/x-icon" href="img/icon.ico" />
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Alpine.js & App Logic -->
    <script src="js/vendor/alpine.js" defer></script>
    <script src="js/app.js"></script>
  </head>

  <body x-data="netherlinkApp">
    <!-- Background Video -->
    <video id="bgVideo" autoplay muted loop playsinline class="bg-video">
      <source src="videos/panorama-bg.mp4" type="video/mp4" />
    </video>

    <!-- Background Music -->
    <audio id="bgMusic"></audio>

    <!-- Nether Portal Sound -->
    <audio id="netherSound">
      <source src="sfx/nether.mp3" type="audio/mpeg" />
    </audio>

    <!-- Portal Animation Overlay -->
    <div
      id="portalOverlay"
      class="portal-overlay"
      :class="{ 'active': portalActive }"
    >
      <img src="img/portal_anim.png" alt="Portal" class="portal-animation" />
    </div>

    <!-- Minecraft Loading Screen -->
    <div
      id="loadingScreen"
      class="loading-screen"
      x-show="loading"
      x-transition:leave.opacity.duration.500ms
    >
      <div class="loading-content">
        <img src="img/logo.png" alt="Netherlink" class="loading-logo" /><br />
        <div class="loading-text">Building Terrain</div>
        <div class="loading-status" x-text="loadingMessage">
          Checking devices...
        </div>
        <div class="loading-bar">
          <div
            class="loading-progress"
            :style="`width: ${loadingProgress}%`"
          ></div>
        </div>
      </div>
    </div>

    <!-- Main Menu Page -->
    <div
      class="container"
      id="mainMenu"
      x-show="page === 'main' && !showOptions && !showQuit"
    >
      <div class="logo-container">
        <img src="img/logo.png" alt="CNI Netherlink" class="logo" />
        <div class="splash-text" x-text="splashText">CNI 2025/2!</div>
      </div>

      <div class="mc-menu">
        <button class="mc-button" @click="navigate('terminal')">
          Terminal Servers
        </button>
        <button class="mc-button" @click="navigate('proxmox')">
          Proxmox Hosts
        </button>
        <div class="double">
          <button class="mc-button" @click="openOptions()">Options</button>
          <button class="mc-button" @click="openQuit()">Quit Game</button>
        </div>
      </div>

      <div
        class="jukebox-player"
        x-show="page === 'main' && !showOptions && !showQuit"
        style="display: none"
      >
        <div class="jukebox-art">
          <img src="img/jukebox.webp" alt="Minecraft jukebox" />
        </div>
        <div class="jukebox-info">
          <div class="jukebox-label">Now Playing</div>
          <div
            class="jukebox-title"
            x-text="currentTrackTitle || (jukeboxLoading ? 'Loading soundtrack...' : 'Click anywhere to start the jukebox')"
          ></div>
          <div class="jukebox-subtitle">
            <span x-show="musicStarted">Shuffling timeless overworld vibes</span>
            <span x-show="!musicStarted">Ready to spin random tracks</span>
          </div>
          <div class="jukebox-progress" x-show="currentTrackTitle" style="display: none">
            <div class="slider-container">
              <span
                class="slider-label"
                x-text="`${formatTime(trackPosition)} / ${formatTime(trackDuration)}`"
              >0:00 / --:--</span>
              <input
                type="range"
                class="volume-slider"
                min="0"
                step="0.1"
                :max="trackDuration || 0"
                x-model.number="trackPosition"
                @input="handleSeekInput($event.target.value)"
                :disabled="!musicStarted || !trackDuration"
              />
            </div>
          </div>
          <div class="jukebox-controls">
            <button
              class="mc-button small"
              @click="playPreviousTrack()"
              :disabled="!trackHistory.length"
            >
              Previous
            </button>
            <button
              class="mc-button small"
              @click="togglePause()"
            >
              <span x-text="isMusicPaused ? 'Resume' : 'Pause'"></span>
            </button>
            <button
              class="mc-button small"
              @click="skipTrack()"
              :disabled="!musicStarted"
            >
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Server Selection Page -->
    <div
      class="server-select-container"
      id="serverSelectPage"
      x-show="page !== 'main' && !showOptions && !showQuit"
      style="display: none"
    >
      <div class="title-bar">
        <div
          class="title-text"
          x-text="page === 'terminal' ? 'Terminal Servers' : 'Proxmox Hosts'"
        >
          Select Server
        </div>
        <div class="subtitle-text">CNI Network Lab 306</div>
      </div>

      <div class="server-lists">
        <div class="server-section">
          <div class="section-header">
            <span
              class="section-title"
              x-text="page === 'terminal' ? 'Servers' : 'Proxmox Hosts'"
              >Servers</span
            >
            <span
              class="section-count"
              x-text="`${page === 'terminal' ? devices.filter(d => d.online).length : proxmoxHosts.filter(h => h.online).length}/${page === 'terminal' ? devices.length : proxmoxHosts.length} Online`"
              >0/0 Online</span
            >
          </div>

          <div class="server-list" id="serverList">
            <!-- Terminal Servers List -->
            <template x-if="page === 'terminal'">
              <template x-for="device in visibleDevices()" :key="device.ip">
                <div
                  class="server-item"
                  :class="{ 'offline': !device.online }"
                  @click="openSSH(device.ip)"
                  @mousedown="playClick()"
                >
                  <div class="server-info">
                    <div class="server-ip" x-text="device.ip"></div>
                    <div
                      class="server-name"
                      x-text="`${device.name} - ${device.location}`"
                    ></div>
                  </div>
                  <div class="server-stats">
                    <div class="player-count" x-text="`${device.connCount}/16`">
                      0/16
                    </div>
                    <div
                      class="ping-indicator"
                      :class="{ 'offline': !device.online }"
                    >
                      <img
                        :src="getPingImage(device.latency)"
                        alt="Ping status"
                        class="ping-icon"
                      />
                    </div>
                  </div>
                  <div
                    class="help-icon-inline"
                    title="Connection tips"
                    @click.stop="openTips(device.ip)"
                    @mousedown.stop
                  >
                    ?
                  </div>
                </div>
              </template>
            </template>

            <!-- Proxmox Hosts List -->
            <template x-if="page === 'proxmox'">
              <template x-for="host in visibleProxmox()" :key="host.ip">
                <div
                  class="server-item"
                  :class="{ 'offline': !host.online }"
                  @click="openProxmox(host.ip)"
                  @mousedown="playClick()"
                >
                  <div class="server-info">
                    <div class="server-ip" x-text="host.ip"></div>
                    <div
                      class="server-name"
                      x-text="`${host.name} - ${host.location}`"
                    ></div>
                  </div>
                  <div class="server-stats">
                    <div class="player-count" x-text="`${host.connCount}/∞`">
                      0/∞
                    </div>
                    <div
                      class="ping-indicator"
                      :class="{ 'offline': !host.online }"
                    >
                      <img
                        :src="getPingImage(host.latency)"
                        alt="Ping status"
                        class="ping-icon"
                      />
                    </div>
                  </div>
                </div>
              </template>
            </template>

            <div
              x-show="(page === 'terminal' && devices.length === 0) || (page === 'proxmox' && proxmoxHosts.length === 0)"
              style="color: #ddd; text-align: center; padding: 20px"
            >
              No servers found.
            </div>
          </div>

          <div class="scan-text">
            Scan for games on your local network<br />
            <span class="scan-dots" x-text="scanDots">O o O</span>
          </div>
        </div>
      </div>

      <div class="bottom-buttons">
        <button class="mc-button" @click="navigate('main')">Back</button>
        <button class="mc-button" @click="refresh()">Refresh</button>
      </div>
    </div>

    <!-- Options Screen -->
    <div
      class="options-screen"
      id="optionsScreen"
      x-show="showOptions"
      style="display: none"
    >
      <div class="options-content">
        <div class="options-title">Options</div>

        <div class="options-list">
          <!-- Sound Volume Control -->
          <div class="option-item">
            <div class="slider-container">
              <span class="slider-label" x-text="`Sound: ${soundVolume}%`"
                >Sound: 100%</span
              >
              <input
                type="range"
                class="volume-slider"
                min="0"
                max="100"
                x-model="soundVolume"
              />
            </div>
          </div>
          <div class="option-item">
            <div class="slider-container">
              <span class="slider-label" x-text="`Music: ${musicVolume}%`"
                >Music: 100%</span
              >
              <input
                type="range"
                class="volume-slider"
                min="0"
                max="100"
                x-model="musicVolume"
              />
            </div>
          </div>
        </div>

        <button class="mc-button done-button" @click="closeOptions()">
          Done
        </button>
      </div>
    </div>

    <!-- Quit Error Screen -->
    <div
      class="quit-screen"
      id="quitScreen"
      x-show="showQuit"
      style="display: none"
    >
      <div class="quit-content">
        <div class="quit-title">Failed to quit the game</div>
        <div class="quit-subtitle">
          You will have to continue this path with suffering:
        </div>
        <button class="mc-button" @click="closeQuit()">
          Back to Main Menu
        </button>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="footer"
      id="mainFooter"
      x-show="page === 'main' && !showOptions && !showQuit"
    >
      Made with <img src="img/heart.png" alt="love" class="heart-icon" /> by
      <a
        href="https://github.com/NonsanXX"
        target="_blank"
        rel="noopener"
        class="footer-link"
        >@Phuriphat</a
      >
    </footer>

    <!-- Global tips overlay -->
    <div
      id="tipsOverlay"
      class="tips-overlay"
      :class="{ 'visible': tipsOpen }"
      :aria-hidden="!tipsOpen"
    >
      <div class="tips-backdrop" @click="closeTips()"></div>
      <div
        class="tips-modal"
        role="dialog"
        aria-modal="true"
        aria-label="Connection tips"
      >
        <div class="tips-title">Connection tips</div>
        <div class="tips-note">
          If your SSH client (or PuTTY) can't negotiate legacy algorithms or you
          don't have a modern SSH client, use the command below. Otherwise, just
          click a device to open it.
        </div>
        <div class="tips-section">
          <div class="tips-label">OpenSSH command:</div>
          <code class="tips-code" x-text="sshCmd"></code>
          <button class="tips-copy" @click="copyToClipboard(sshCmd, 'SSH')">
            Copy
          </button>
        </div>
        <div class="tips-section">
          <div class="tips-label">Telnet command:</div>
          <code class="tips-code" x-text="telnetCmd"></code>
          <button
            class="tips-copy"
            @click="copyToClipboard(telnetCmd, 'Telnet')"
          >
            Copy
          </button>
        </div>
      </div>
    </div>

    <div
      id="statusMessage"
      class="status-message"
      :class="[statusMessage ? 'visible' : '', statusType]"
      x-text="statusMessage"
    ></div>
  </body>
</html>
