<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netherlink</title>
    <link rel="icon" type="image/x-icon" href="img/icon.ico">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Background Video -->
    <video id="bgVideo" autoplay muted loop playsinline class="bg-video">
        <source src="videos/panorama-bg.mp4" type="video/mp4">
    </video>

    <!-- Background Music -->
    <audio id="bgMusic" loop>
        <source src="sounds/song.mp3" type="audio/mpeg">
    </audio>

    <!-- Nether Portal Sound -->
    <audio id="netherSound">
        <source src="sounds/nether.mp3" type="audio/mpeg">
    </audio>

    <!-- Portal Animation Overlay -->
    <div id="portalOverlay" class="portal-overlay">
        <img src="img/portal_anim.png" alt="Portal" class="portal-animation">
    </div>

    <!-- Minecraft Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <img src="img/logo.png" alt="Netherlink" class="loading-logo"><br>
            <div class="loading-text">Building Terrain</div>
            <div class="loading-status">Checking devices...</div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="logo-container">
            <img src="img/logo.png" alt="Netherlink | CNI 2025/2" class="logo">
            <div class="splash-text"></div>
        </div>

        <h2>Terminal Servers</h2>
        <p class="subtitle">Click any device to open SSH</p>
        <div class="device-grid" id="deviceGrid"></div>

        <h2 style="margin-top:40px;">Proxmox Hosts</h2>
        <p class="subtitle">Open the Proxmox web interface</p>
        <div class="device-grid" id="proxmoxGrid"></div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        Made with <img src="img/heart.png" alt="love" class="heart-icon"> by 
        <a href="https://github.com/NonsanXX" target="_blank" rel="noopener" class="footer-link">@Phuriphat</a>
        and friends.
    </footer>

    <!-- Global tips overlay (above everything) -->
    <div id="tipsOverlay" class="tips-overlay" aria-hidden="true">
        <div class="tips-backdrop"></div>
        <div class="tips-modal" role="dialog" aria-modal="true" aria-label="Connection tips">
            <button id="tipsClose" class="tips-close" aria-label="Close">Ã—</button>
            <div class="tips-title">Connection tips</div>
            <div class="tips-note">If your SSH client (or PuTTY) can't negotiate legacy algorithms or you don't have a
                modern SSH client, use the command below. Otherwise, just click a device to open it.</div>
            <div class="tips-section">
                <div class="tips-label">OpenSSH command:</div>
                <code id="overlaySshCmd" class="tips-code"></code>
                <button id="overlayCopySsh" class="tips-copy">Copy</button>
            </div>
            <div class="tips-section">
                <div class="tips-label">Telnet command:</div>
                <code id="overlayTelnetCmd" class="tips-code"></code>
                <button id="overlayCopyTelnet" class="tips-copy">Copy</button>
            </div>
        </div>
    </div>
    <div id="statusMessage" class="status-message"></div>

    <script>
        // Background music
        const bgMusic = document.getElementById('bgMusic');
        bgMusic.volume = 0.1;
        
        // Play music on first user interaction
        let musicStarted = false;
        document.addEventListener('click', () => {
            if (!musicStarted) {
                bgMusic.play().catch(() => {});
                musicStarted = true;
            }
        }, { once: true });

        // Minecraft click sound
        const clickSound = new Audio('sounds/minecraft_click.mp3');
        clickSound.volume = 0.5;

        function playClickSound() {
            try {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            } catch (e) {}
        }

        // Nether portal sound and animation
        const netherSound = document.getElementById('netherSound');
        const portalOverlay = document.getElementById('portalOverlay');
        netherSound.volume = 0.05;

        function showPortalAnimation(callback) {
            // Play nether sound
            try {
                netherSound.currentTime = 0;
                netherSound.play().catch(() => {});
            } catch (e) {}

            // Show portal overlay
            portalOverlay.classList.add('active');

            // Execute callback and hide after animation
            setTimeout(() => {
                if (callback) callback();
                setTimeout(() => {
                    portalOverlay.classList.remove('active');
                }, 500);
            }, 1000);
        }

        const statusEl = document.getElementById('statusMessage');
        let statusTimer;
        let devices = [];
        let proxmoxHosts = [];
        let healthTimer = null;
        let lastIpForHelp = null;
        let activeTips = null; // currently open tips overlay element
        let initialHealthCheckDone = false;

        // Load and set random splash text (for main page only)
        async function setRandomSplash() {
            try {
                const response = await fetch('splashtext.json');
                const splashTexts = await response.json();
                const splashEl = document.querySelector('.container .splash-text');
                if (splashEl && splashTexts.length > 0) {
                    const randomText = splashTexts[Math.floor(Math.random() * splashTexts.length)];
                    splashEl.textContent = randomText;
                }
            } catch (error) {
                console.error('Error loading splash text:', error);
                // Fallback text
                const splashEl = document.querySelector('.container .splash-text');
                if (splashEl) {
                    splashEl.textContent = 'CNI 2025/2!';
                }
            }
        }

        // Set splash text after page loads
        window.addEventListener('DOMContentLoaded', setRandomSplash);

        function updateLoadingProgress(percent) {
            const progressBar = document.querySelector('.loading-progress');
            if (progressBar) {
                progressBar.style.width = percent + '%';
            }
        }

        function updateLoadingStatus(message) {
            const statusEl = document.querySelector('.loading-status');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }

        function showStatus(message, type = 'info') {
            if (!statusEl) return;
            clearTimeout(statusTimer);
            statusEl.textContent = message;
            statusEl.className = `status-message visible ${type}`;
            statusTimer = setTimeout(() => {
                statusEl.classList.remove('visible');
            }, 3000);
        }

        async function loadDevices() {
            try {
                // Load both devices and proxmox in parallel
                const [devicesResponse, proxmoxResponse] = await Promise.all([
                    fetch('devices.json'),
                    fetch('proxmox.json')
                ]);
                
                devices = await devicesResponse.json();
                proxmoxHosts = await proxmoxResponse.json();
                
                renderDevices(devices);
                renderProxmox(proxmoxHosts);
                
                await startHealthMonitor(); // Wait for initial health check
                // Nothing else needed here; tips are shown per-card on demand
            } catch (error) {
                console.error('Error loading devices:', error);
                document.getElementById('deviceGrid').innerHTML =
                    '<p style="color:#475569; text-align:center;">Error loading devices. Please check devices.json.</p>';
                hideLoadingScreen();
            }
        }

        function openSSH(ip) {
            lastIpForHelp = ip;
            // Close any open tips when navigating/opening
            closeTips();
            
            // Show portal animation then open SSH
            showPortalAnimation(() => {
                try {
                    window.location.href = `ssh://cisco@${ip}`;
                } catch (e) {
                    showStatus('SSH handler not available on this device', 'error');
                }
            });
        }

        function openTips(ip) {
            playClickSound();
            const overlay = document.getElementById('tipsOverlay');
            if (!overlay) return;
            lastIpForHelp = ip;
            document.getElementById('overlaySshCmd').textContent = `ssh cisco@${ip} -o KexAlgorithms=+diffie-hellman-group1-sha1 -o HostKeyAlgorithms=+ssh-rsa -c aes128-cbc`;
            document.getElementById('overlayTelnetCmd').textContent = `telnet ${ip}`;
            overlay.classList.add('visible');
            activeTips = overlay;
        }

        function closeTips() {
            const overlay = document.getElementById('tipsOverlay');
            if (overlay) overlay.classList.remove('visible');
            activeTips = null;
        }

        function renderDevices(list) {
            const grid = document.getElementById('deviceGrid');
            grid.innerHTML = '';
            if (!list || list.length === 0) {
                grid.innerHTML = '<p style="color:#475569; text-align:center;">No devices found.</p>';
                return;
            }
            list.forEach(device => {
                const ipId = device.ip.replace(/\./g, '_');
                const card = document.createElement('div');
                card.className = 'device-card';
                card.setAttribute('data-ip', device.ip);
                card.onclick = () => openSSH(device.ip);
                card.onmousedown = () => playClickSound();
                card.innerHTML = `
                    <button class="help-icon" title="Connection tips">?</button>
                    <div class="card-row">
                        <div>
                            <div class="device-ip">${device.ip}</div>
                            <div class="device-name">${device.name}</div>
                            <div class="device-location">${device.location}</div>
                        </div>
                        <div>
                            <div class="device-status" id="status-${ipId}"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
                const helpBtn = card.querySelector('.help-icon');
                if (helpBtn) {
                    helpBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openTips(device.ip);
                    });
                }
                checkHealth(device.ip).catch(() => { });
            });
        }

        function renderProxmox(list) {
            const grid = document.getElementById('proxmoxGrid');
            if (!grid) return;
            grid.innerHTML = '';
            if (!list || list.length === 0) {
                grid.innerHTML = '<p style="color:#475569; text-align:center;">No Proxmox hosts found.</p>';
                return;
            }
            list.forEach(host => {
                const ip = host.ip;
                const card = document.createElement('a');
                card.className = 'device-card';
                card.href = `https://${ip}:8006/`;
                card.target = '_blank';
                card.rel = 'noopener';
                card.setAttribute('data-ip', ip);
                card.onclick = (e) => {
                    e.preventDefault();
                    showPortalAnimation(() => {
                        window.open(`https://${ip}:8006/`, '_blank', 'noopener');
                    });
                };
                card.innerHTML = `
                    <div class="card-row">
                        <div>
                            <div class="device-ip">${host.ip}</div>
                            <div class="device-name">${host.name || 'Proxmox VE'}</div>
                            <div class="device-location">${host.location || ''}</div>
                        </div>
                        <div>
                            <div class="device-status" id="status-prox-${ip.replace(/\./g, '_')}"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
                // Initial health check for Proxmox UI
                checkProxmoxHealth(ip).catch(() => { });
            });
        }

        async function checkHealth(ip) {
            const card = document.querySelector(`.device-card[data-ip="${ip}"]`);
            const badge = document.getElementById(`status-${ip.replace(/\./g, '_')}`);
            try {
                const res = await fetch(`/health?ip=${encodeURIComponent(ip)}`);
                const data = await res.json();
                if (data.up) {
                    card && card.classList.remove('offline');
                    if (badge) { badge.textContent = 'Up'; badge.classList.add('up'); badge.classList.remove('down'); }
                } else {
                    card && card.classList.add('offline');
                    if (badge) { badge.textContent = 'Down'; badge.classList.add('down'); badge.classList.remove('up'); }
                }
            } catch (e) {
                card && card.classList.add('offline');
                if (badge) { badge.textContent = 'Down'; badge.classList.add('down'); badge.classList.remove('up'); }
            }
        }

        async function startHealthMonitor() {
            if (healthTimer) clearInterval(healthTimer);
            const runAll = async () => {
                const totalChecks = devices.length + (Array.isArray(proxmoxHosts) ? proxmoxHosts.length : 0);
                let completedChecks = 0;

                if (!initialHealthCheckDone) {
                    updateLoadingStatus(`Checking ${devices.length} terminal servers...`);
                }

                const deviceChecks = devices.map(d => 
                    checkHealth(d.ip).catch(() => {}).finally(() => {
                        completedChecks++;
                        if (!initialHealthCheckDone) {
                            updateLoadingProgress((completedChecks / totalChecks) * 100);
                            if (completedChecks === devices.length) {
                                updateLoadingStatus(`Checking ${proxmoxHosts.length} Proxmox hosts...`);
                            }
                        }
                    })
                );
                
                const proxmoxChecks = Array.isArray(proxmoxHosts) 
                    ? proxmoxHosts.map(h => 
                        checkProxmoxHealth(h.ip).catch(() => {}).finally(() => {
                            completedChecks++;
                            if (!initialHealthCheckDone) {
                                updateLoadingProgress((completedChecks / totalChecks) * 100);
                                if (completedChecks === totalChecks) {
                                    updateLoadingStatus('All checks completed!');
                                }
                            }
                        })
                    )
                    : [];
                
                await Promise.all([...deviceChecks, ...proxmoxChecks]);
                
                // Hide loading screen after first health check completes
                if (!initialHealthCheckDone) {
                    initialHealthCheckDone = true;
                    setTimeout(hideLoadingScreen, 300);
                }
            };
            await runAll();
            healthTimer = setInterval(runAll, 5000);
        }

        // No global toggle/copy handlers; tips are per-card popovers now

        loadDevices();

        async function checkProxmoxHealth(ip) {
            const badge = document.getElementById(`status-prox-${ip.replace(/\./g, '_')}`);
            const card = document.querySelector(`#proxmoxGrid .device-card[data-ip="${ip}"]`);
            try {
                const res = await fetch(`/proxmox-health?ip=${encodeURIComponent(ip)}`);
                const data = await res.json();
                if (data.up) {
                    if (badge) { badge.textContent = 'Up'; badge.classList.add('up'); badge.classList.remove('down'); }
                    if (card) card.classList.remove('offline');
                } else {
                    if (badge) { badge.textContent = 'Down'; badge.classList.add('down'); badge.classList.remove('up'); }
                    if (card) card.classList.add('offline');
                }
            } catch (e) {
                if (badge) { badge.textContent = 'Down'; badge.classList.add('down'); badge.classList.remove('up'); }
                if (card) card.classList.add('offline');
            }
        }

        // Dismiss tips on outside click or Escape
        const overlay = document.getElementById('tipsOverlay');
        if (overlay) {
            overlay.addEventListener('click', (e) => {
                if (e.target && e.target.classList && e.target.classList.contains('tips-backdrop')) {
                    closeTips();
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTips();
            }
        });

        // Wire overlay copy and close buttons
        const overlayCopySsh = document.getElementById('overlayCopySsh');
        const overlayCopyTelnet = document.getElementById('overlayCopyTelnet');
        const tipsClose = document.getElementById('tipsClose');
        if (overlayCopySsh) {
            overlayCopySsh.addEventListener('click', async (e) => {
                playClickSound();
                e.stopPropagation();
                const text = document.getElementById('overlaySshCmd').textContent;
                try {
                    await navigator.clipboard.writeText(text);
                    showStatus('SSH command copied', 'success');
                } catch {
                    showStatus('Copy failed. Select and copy manually.', 'error');
                }
            });
        }
        if (overlayCopyTelnet) {
            overlayCopyTelnet.addEventListener('click', async (e) => {
                playClickSound();
                e.stopPropagation();
                const text = document.getElementById('overlayTelnetCmd').textContent;
                try {
                    await navigator.clipboard.writeText(text);
                    showStatus('Telnet command copied', 'success');
                } catch {
                    showStatus('Copy failed. Select and copy manually.', 'error');
                }
            });
        }
        if (tipsClose) {
            tipsClose.addEventListener('click', (e) => {
                playClickSound();
                e.stopPropagation();
                closeTips();
            });
        }
    </script>
</body>

</html>